# haizzz

```
echo 0 > /proc/sys/kernel/randomize_va_space
```

A vulnerable program `bufferoverflow.c`

```
#include <stdio.h>
#include <unistd.h>
int vuln() {
    // Define variables
    char arr[400];
    int return_status;
    // Grab user input
    printf("What's your name?\n");
    return_status = read(0, arr, 800);
    // Print user input
    printf("Hey %s", arr);
    // Return success
    return 0;
}
int main(int argc, char *argv[]) {
    // Call vulnerable function
    vuln();
    // Return success
    return 0;
}
```

Biên dịch 

```
gcc -fno-stack-protector -z execstack -o bufferoverflow bufferoverflow.c
```

Sinh ra một file chứa 500 kí tự A 

```
python -c "print 'A'*500" > textfile
```

Bảng mã ASCII

<img src='https://i.imgur.com/K7m7yEE.png'>

Debug 

```
gdb -q ./bufferoverflow
```

Đặt break point 

```
[root@docker example]# gdb -q ./bufferoverflow
Reading symbols from /root/example/bufferoverflow...(no debugging symbols found)...done.
(gdb) disassemble vuln 
Dump of assembler code for function vuln:
   0x00000000004005ad <+0>:	push   %rbp
   0x00000000004005ae <+1>:	mov    %rsp,%rbp
   0x00000000004005b1 <+4>:	sub    $0x1a0,%rsp
   0x00000000004005b8 <+11>:	mov    $0x4006b0,%edi
   0x00000000004005bd <+16>:	callq  0x400470 <puts@plt>
   0x00000000004005c2 <+21>:	lea    -0x1a0(%rbp),%rax
   0x00000000004005c9 <+28>:	mov    $0x320,%edx
   0x00000000004005ce <+33>:	mov    %rax,%rsi
   0x00000000004005d1 <+36>:	mov    $0x0,%edi
   0x00000000004005d6 <+41>:	callq  0x400490 <read@plt>
   0x00000000004005db <+46>:	mov    %eax,-0x4(%rbp)
   0x00000000004005de <+49>:	lea    -0x1a0(%rbp),%rax
   0x00000000004005e5 <+56>:	mov    %rax,%rsi
   0x00000000004005e8 <+59>:	mov    $0x4006c2,%edi
   0x00000000004005ed <+64>:	mov    $0x0,%eax
   0x00000000004005f2 <+69>:	callq  0x400480 <printf@plt>
   0x00000000004005f7 <+74>:	mov    $0x0,%eax
   0x00000000004005fc <+79>:	leaveq 
   0x00000000004005fd <+80>:	retq   
End of assembler dump.
(gdb) b * vuln+41
Breakpoint 1 at 0x4005d6
```

Run và truyền đối số là nội dung của `textfile` đã tạo 

```
(gdb) r < textfile 
Starting program: /root/example/./bufferoverflow < textfile
What's your name?

Breakpoint 1, 0x00000000004005d6 in vuln ()
```

Hiển thị địa chỉ con trỏ `rsp` và `rbp`

```
(gdb) x $rsp
0x7fffffffe160:	0x00000000
(gdb) x $rbp
0x7fffffffe300:	0xffffe320
```

In ra 120 địa chỉ tiếp theo từ địa chỉ rsp

```
(gdb) x/120x $rsp
0x7fffffffe160:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe170:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe180:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe190:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe1a0:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe1b0:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe1c0:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe1d0:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe1e0:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe1f0:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe200:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe210:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe220:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe230:	0x00000000	0x00000000	0xf7ffea68	0x00007fff
0x7fffffffe240:	0xffffe270	0x00007fff	0xffffe260	0x00007fff
0x7fffffffe250:	0x6562b026	0x00000000	0xf7b94867	0x00007fff
0x7fffffffe260:	0x00b01045	0x00000000	0xf7a44c48	0x00007fff
0x7fffffffe270:	0xffffe2c0	0x00007fff	0xf7b91060	0x00007fff
0x7fffffffe280:	0x00000002	0x00000000	0x00000000	0x00000000
0x7fffffffe290:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe2a0:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe2b0:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe2c0:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe2d0:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe2e0:	0x00000001	0x00000000	0x0040066d	0x00000000
0x7fffffffe2f0:	0x00000000	0x00000000	0x00000000	0x00000000
0x7fffffffe300:	0xffffe320	0x00007fff	0x00400617	0x00000000
0x7fffffffe310:	0xffffe408	0x00007fff	0x00000000	0x00000001
0x7fffffffe320:	0x00000000	0x00000000	0xf7a2f505	0x00007fff
0x7fffffffe330:	0x00000000	0x00000000	0xffffe408	0x00007fff
```

nexti

```
(gdb) nexti 
0x00000000004005db in vuln ()
```

In lại 120 địa chỉ 

```
(gdb) x/120x $rsp
0x7fffffffe160:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe170:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe180:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe190:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe1a0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe1b0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe1c0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe1d0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe1e0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe1f0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe200:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe210:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe220:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe230:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe240:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe250:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe260:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe270:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe280:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe290:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe2a0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe2b0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe2c0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe2d0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe2e0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe2f0:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe300:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe310:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe320:	0x41414141	0x41414141	0x41414141	0x41414141
0x7fffffffe330:	0x41414141	0x41414141	0x41414141	0x41414141
```

Generate Overflow Pattern

https://zerosum0x0.blogspot.com/2016/11/overflow-exploit-pattern-generator.html

Tạo file fuzzing có nội dung như sau 

```
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq
```

Run và truyền đối số từ file fuzzing 

```
[root@docker example]# gdb -q ./bufferoverflow
Reading symbols from /root/example/bufferoverflow...(no debugging symbols found)...done.
(gdb) run < fuzzing 
Starting program: /root/example/./bufferoverflow < fuzzing
What's your name?

Program received signal SIGSEGV, Segmentation fault.
0x00000000004005fd in vuln ()
```

In ra 120 địa chỉ bắt đầu từ địa chỉ esp `0x7fffffffe160`

```
(gdb) x/120x 0x7fffffffe160
0x7fffffffe160:	0x41306141	0x61413161	0x33614132	0x41346141
0x7fffffffe170:	0x61413561	0x37614136	0x41386141	0x62413961
0x7fffffffe180:	0x31624130	0x41326241	0x62413362	0x35624134
0x7fffffffe190:	0x41366241	0x62413762	0x39624138	0x41306341
0x7fffffffe1a0:	0x63413163	0x33634132	0x41346341	0x63413563
0x7fffffffe1b0:	0x37634136	0x41386341	0x64413963	0x31644130
0x7fffffffe1c0:	0x41326441	0x64413364	0x35644134	0x41366441
0x7fffffffe1d0:	0x64413764	0x39644138	0x41306541	0x65413165
0x7fffffffe1e0:	0x33654132	0x41346541	0x65413565	0x37654136
0x7fffffffe1f0:	0x41386541	0x66413965	0x31664130	0x41326641
0x7fffffffe200:	0x66413366	0x35664134	0x41366641	0x66413766
0x7fffffffe210:	0x39664138	0x41306741	0x67413167	0x33674132
0x7fffffffe220:	0x41346741	0x67413567	0x37674136	0x41386741
0x7fffffffe230:	0x68413967	0x31684130	0x41326841	0x68413368
0x7fffffffe240:	0x35684134	0x41366841	0x68413768	0x39684138
0x7fffffffe250:	0x41306941	0x69413169	0x33694132	0x41346941
0x7fffffffe260:	0x69413569	0x37694136	0x41386941	0x6a413969
0x7fffffffe270:	0x316a4130	0x41326a41	0x6a41336a	0x356a4134
0x7fffffffe280:	0x41366a41	0x6a41376a	0x396a4138	0x41306b41
0x7fffffffe290:	0x6b41316b	0x336b4132	0x41346b41	0x6b41356b
0x7fffffffe2a0:	0x376b4136	0x41386b41	0x6c41396b	0x316c4130
0x7fffffffe2b0:	0x41326c41	0x6c41336c	0x356c4134	0x41366c41
0x7fffffffe2c0:	0x6c41376c	0x396c4138	0x41306d41	0x6d41316d
0x7fffffffe2d0:	0x336d4132	0x41346d41	0x6d41356d	0x376d4136
0x7fffffffe2e0:	0x41386d41	0x6e41396d	0x316e4130	0x41326e41
0x7fffffffe2f0:	0x6e41336e	0x356e4134	0x41366e41	0x000001f5
0x7fffffffe300:	0x396e4138	0x41306f41	0x6f41316f	0x336f4132
0x7fffffffe310:	0x41346f41	0x6f41356f	0x376f4136	0x41386f41
0x7fffffffe320:	0x7041396f	0x31704130	0x41327041	0x70413370
0x7fffffffe330:	0x35704134	0x41367041	0x70413770	0x39704138
```

Để ý 

```
0x7fffffffe300:	0x396e4138	0x41306f41	=>>0x6f41316f	0x336f4132
```

Đổi cơ số 

`0x6f41316f	0x336f4132` tương đương `o1Ao 2Ao3`

Tìm offset ở trang <a href="https://zerosum0x0.blogspot.com/2016/11/overflow-exploit-pattern-generator.html"> này </a>. Và kết quả là:

```
424
```

to be continued